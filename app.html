<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EDGRIND â€” Result Calculator</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="./style.css">
</head>
<body class="loading">
    <div id="app-preloader">
        <div class="loader-content">
            <div class="spinner"></div>
            <div class="loader-text">ADLYZERRA<span>.</span></div>
        </div>
    </div>

    <main id="app-main" style="display: none;">
        <div class="container">
    
<!-- HEADER -->
<div class="header">
  <div class="logo">EDGRIND</div>
  <div class="header-right">
    <div class="tagline">Science-based result calculator<br><strong>1 kg fat = 8,000 kcal deficit</strong></div>
  </div>
</div>

<!-- INPUT GRID -->
<div class="two-col" id="input-section">

  <div class="card">
    <div class="card-title">Your Stats</div>
    <div class="two-col" style="gap:10px;">
      <div class="field span2">
        <label>Sex</label>
        <div class="seg">
          <button class="seg-btn on" onclick="setSex('male',this)">Male</button>
          <button class="seg-btn" onclick="setSex('female',this)">Female</button>
        </div>
      </div>
      <div class="field">
        <label>Age</label>
        <div class="input-wrap">
          <input type="number" id="age" placeholder="28" min="15" max="90">
          <span class="unit">yrs</span>
        </div>
      </div>
      <div class="field">
        <label>Height</label>
        <div class="input-wrap">
          <input type="number" id="height" placeholder="175" min="100" max="250">
          <span class="unit">cm</span>
        </div>
      </div>
      <div class="field">
        <label>Current Weight</label>
        <div class="input-wrap">
          <input type="number" id="weight" placeholder="90" min="30" max="300">
          <span class="unit">kg</span>
        </div>
      </div>
      <div class="field">
        <label>Goal Weight</label>
        <div class="input-wrap">
          <input type="number" id="goal-weight" placeholder="75" min="30" max="300">
          <span class="unit">kg</span>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Activity & Plan</div>
    <div style="display:flex;flex-direction:column;gap:10px;">
      <div class="field">
        <label>Activity Level</label>
        <div class="input-wrap">
          <select id="activity">
            <option value="1.2">Sedentary (desk job, no exercise)</option>
            <option value="1.375">Light (1â€“3 workouts/week)</option>
            <option value="1.55" selected>Moderate (3â€“5 workouts/week)</option>
            <option value="1.725">Active (6â€“7 workouts/week)</option>
            <option value="1.9">Very Active (2Ã— training/day)</option>
          </select>
        </div>
      </div>
      <div class="field">
        <label>Deficit Target</label>
        <div class="input-wrap">
          <select id="deficit">
            <option value="250">Gentle  âˆ’250 kcal/day (~0.5 kg/month)</option>
            <option value="500" selected>Standard âˆ’500 kcal/day (~1 kg/month)</option>
            <option value="750">Aggressive âˆ’750 kcal/day (~1.5 kg/month)</option>
          </select>
        </div>
      </div>
      <div class="info-strip">
        <span class="ic">âš¡</span>
        Macros calculated for your <strong>goal weight</strong> â€” so you're already eating like that person.
      </div>
      <button class="calc-btn" onclick="calculate()">CALCULATE  â†’</button>
    </div>
  </div>
</div>

<!-- IDEAL WEIGHT PANEL (shows after calc) -->
<div class="ideal-panel reveal" id="ideal-panel" style="display:none;">
  <div class="ideal-header">
    <div>
      <div class="ideal-title">âš–ï¸ WEIGHT ANALYSIS & RECOMMENDATIONS</div>
      <div style="font-size:11px;color:var(--muted);margin-top:3px;letter-spacing:1px;text-transform:uppercase;">Based on your height, age & sex</div>
    </div>
    <div class="bmi-badge" id="bmi-badge">BMI â€”</div>
  </div>

  <!-- BMI Scale -->
  <div style="margin-bottom:16px;">
    <div class="bmi-scale">
      <div class="bmi-seg" style="background:#4ea8ff;flex:2;" title="Underweight <18.5"></div>
      <div class="bmi-seg" style="background:#ff2442;flex:3;" title="Normal 18.5â€“24.9"></div>
      <div class="bmi-seg" style="background:#ffc107;flex:2;" title="Overweight 25â€“29.9"></div>
      <div class="bmi-seg" style="background:#ff6b35;flex:2;" title="Obese 30â€“34.9"></div>
      <div class="bmi-seg" style="background:#ff4455;flex:2;" title="Obese II 35+"></div>
    </div>
    <div class="bmi-pointer-wrap"><div class="bmi-pointer" id="bmi-pointer">â€”</div></div>
    <div class="bmi-labels">
      <span>&lt;18.5 Underweight</span>
      <span>18.5â€“24.9 Normal</span>
      <span>25â€“29.9 Over</span>
      <span>30â€“34.9 Obese I</span>
      <span>35+ Obese II</span>
    </div>
  </div>

  <!-- Ideal weight formulas -->
  <div class="ideal-grid" id="ideal-grid"></div>

  <!-- Recommendation -->
  <div class="recommendation-box" id="rec-box"></div>
</div>

<!-- RESULTS -->
<div id="results">

  <div class="reveal mt12">
    <div class="kpi-grid">
      <div class="kpi star">
        <div class="kpi-val" id="r-cals">â€”</div>
        <div class="kpi-label">Calories / day</div>
        <div class="kpi-sub">with deficit</div>
      </div>
      <div class="kpi">
        <div class="kpi-val" id="r-prot">â€”</div>
        <div class="kpi-label">Protein g</div>
        <div class="kpi-sub">goal weight</div>
      </div>
      <div class="kpi">
        <div class="kpi-val" id="r-fat">â€”</div>
        <div class="kpi-label">Fat g</div>
        <div class="kpi-sub">goal weight</div>
      </div>
      <div class="kpi">
        <div class="kpi-val" id="r-carb">â€”</div>
        <div class="kpi-label">Carbs g</div>
        <div class="kpi-sub">goal weight</div>
      </div>
    </div>
    <div class="info-strip mt12"><span class="ic">ğŸ“Š</span><span id="r-info"></span></div>
  </div>

  <!-- PROGRESS CARD -->
  <div class="progress-card reveal" style="transition-delay:.08s;">
    <div class="prog-header">
      <div>
        <div class="prog-title">ğŸ”¥ REAL PROGRESS</div>
        <div style="font-size:11px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-top:2px;">Calculated from tracker entries Â· 8,000 kcal = 1 kg fat</div>
      </div>
      <div style="text-align:right;">
        <div class="prog-pct-big" id="prog-pct">0%</div>
        <div class="prog-pct-label">to goal</div>
      </div>
    </div>

    <div class="bar-wrap">
      <div class="bar-track"><div class="bar-fill" id="bar-fill"></div></div>
      <div class="bar-labels">
        <span id="bar-start">â€”</span>
        <span class="bar-mid" id="bar-mid"></span>
        <span id="bar-goal">â€”</span>
      </div>
    </div>

    <div class="stats-row">
      <div class="stat-mini">
        <div class="stat-mini-val" id="rp-lost">0.000</div>
        <div class="stat-mini-label">Fat burned, kg</div>
      </div>
      <div class="stat-mini">
        <div class="stat-mini-val" id="rp-total-def">0</div>
        <div class="stat-mini-label">Total deficit, kcal</div>
      </div>
      <div class="stat-mini">
        <div class="stat-mini-val orange" id="rp-remain">â€”</div>
        <div class="stat-mini-label">Still to lose, kg</div>
      </div>
    </div>

    <div class="countdown-row">
      <div class="ring-wrap">
        <svg width="80" height="80" viewBox="0 0 80 80">
          <circle class="ring-bg" cx="40" cy="40" r="35"/>
          <circle class="ring-fg" id="ring-fg" cx="40" cy="40" r="35"/>
        </svg>
        <div class="ring-text">
          <div class="ring-num" id="cd-days">â€”</div>
          <div class="ring-sub">days</div>
        </div>
      </div>
      <div class="cd-info">
        <h3 id="cd-title">DAYS TO GOAL</h3>
        <p id="cd-desc">Add daily entries to get a real prediction based on your actual average deficit.</p>
      </div>
    </div>
  </div>

</div><!-- /results -->

<!-- TRACKER -->
<div class="tracker-card reveal" style="transition-delay:.04s;">
  <div class="tracker-top">
    <div>
      <div class="tracker-title">DEFICIT TRACKER</div>
      <div class="tracker-sub">Tap a day â†’ log real calories eaten</div>
    </div>
    <div class="tracker-controls">
      <div class="streak-pill">
        <div>
          <div class="streak-val" id="streak-num">0</div>
          <div class="streak-lbl">streak ğŸ”¥</div>
        </div>
      </div>
      <button class="ghost-btn" onclick="confirmReset()">Reset</button>
    </div>
  </div>

  <div class="legend">
    <div class="leg"><div class="leg-dot" style="background:rgba(255,36,66,.2);border-color:rgba(255,36,66,.5);"></div>On track</div>
    <div class="leg"><div class="leg-dot" style="background:rgba(255,107,53,.2);border-color:rgba(255,107,53,.5);"></div>Partial</div>
    <div class="leg"><div class="leg-dot" style="background:rgba(255,68,85,.15);border-color:rgba(255,68,85,.4);"></div>Missed</div>
  </div>

  <div class="month-nav">
    <button class="nav-btn" onclick="chMonth(-1)">â†</button>
    <div class="month-label" id="month-label"></div>
    <button class="nav-btn" onclick="chMonth(1)">â†’</button>
  </div>
  <div class="cal-header" id="cal-header"></div>
  <div class="cal-grid" id="cal-grid"></div>

  <div class="tracker-stats">
    <div class="ts"><div class="ts-val" id="ts-streak">0</div><div class="ts-label">Streak</div></div>
    <div class="ts"><div class="ts-val" id="ts-total">0</div><div class="ts-label">Days logged</div></div>
    <div class="ts"><div class="ts-val" id="ts-avg">â€”</div><div class="ts-label">Avg deficit</div></div>
    <div class="ts"><div class="ts-val" id="ts-rate">0%</div><div class="ts-label">Month rate</div></div>
  </div>

  <div class="tip-row">
    <span class="tip-icon">ğŸ’¡</span>
    <span id="tip-text">Tap any past day to log your real calories. Progress recalculates instantly!</span>
  </div>
</div>

</div><!-- /container -->
<!-- MODAL -->
<div class="overlay" id="overlay" onclick="bgClose(event)">
  <div class="modal">
    <button class="modal-x" onclick="closeModal()">âœ•</button>
    <div class="modal-date" id="m-date"></div>
    <div class="modal-dow" id="m-dow"></div>

    <div class="status-row">
      <button class="status-btn" id="sb-done"    onclick="setStatus('done')"   >âœ“ On track</button>
      <button class="status-btn" id="sb-partial" onclick="setStatus('partial')">~ Partial</button>
      <button class="status-btn" id="sb-miss"    onclick="setStatus('miss')"   >âœ• Missed</button>
    </div>

    <div class="modal-field">
      <label>Calories eaten today</label>
      <div class="input-wrap">
        <input type="number" id="m-eaten" placeholder="1800" min="0" max="9999" oninput="recalcM()">
        <span class="unit">kcal</span>
      </div>
    </div>

    <div class="target-note" id="m-note" style="display:none;"></div>

    <div class="result-strip">
      <div class="rs-item">
        <div class="rs-val pos" id="m-def">â€”</div>
        <div class="rs-label">Deficit kcal</div>
      </div>
      <div class="rs-item">
        <div class="rs-val neu" id="m-fat-g">â€”</div>
        <div class="rs-label">Fat burned g</div>
      </div>
      <div class="rs-item">
        <div class="rs-val neu" id="m-fat-kg">â€”</div>
        <div class="rs-label">Fat burned kg</div>
      </div>
    </div>

    <button class="modal-save" onclick="saveDay()">SAVE DAY</button>
  </div>
</div>
    </main>
<script type="module" src="./js/app-logic.js"></script>
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let sex = 'male';
let days = JSON.parse(localStorage.getItem('fuel_days_v3') || '{}');
let calc = JSON.parse(localStorage.getItem('fuel_calc_v3') || '{}');
let curMonth = new Date().getMonth();
let curYear  = new Date().getFullYear();
let mDate = null, mStatus = null;

const MONTHS = ['January','February','March','April','May','June',
                'July','August','September','October','November','December'];
const DAYS_S = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
const DAYS_F = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   IDEAL WEIGHT FORMULAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function idealWeights(heightCm, sex, age) {
  const h  = heightCm;
  const hIn = h / 2.54;
  const isMale = sex === 'male';

  // Devine (1974) â€” most widely used in clinical settings
  const devine = isMale ? 50 + 2.3 * (hIn - 60) : 45.5 + 2.3 * (hIn - 60);

  // Robinson (1983) â€” similar to Devine, slightly adjusted
  const robinson = isMale ? 52 + 1.9 * (hIn - 60) : 49 + 1.7 * (hIn - 60);

  // Miller (1983)
  const miller = isMale ? 56.2 + 1.41 * (hIn - 60) : 53.1 + 1.36 * (hIn - 60);

  // Hamwi (1964) â€” older but still used
  const hamwi = isMale ? 48 + 2.7 * (hIn - 60) : 45.5 + 2.2 * (hIn - 60);

  // BMI-based ideal range (18.5â€“24.9)
  const hm   = h / 100;
  const bmiLow  = Math.round(18.5 * hm * hm * 10) / 10;
  const bmiHigh = Math.round(24.9 * hm * hm * 10) / 10;

  // Age adjustment: after 40, slight upward tolerance
  const ageAdj = age > 40 ? Math.round((age - 40) * 0.05 * 10) / 10 : 0;

  return {
    devine:   Math.round(devine),
    robinson: Math.round(robinson),
    miller:   Math.round(miller),
    hamwi:    Math.round(hamwi),
    bmiRange: [bmiLow, bmiHigh],
    // Recommended = midpoint of the four formulas + age adj
    recommended: Math.round((devine + robinson + miller + hamwi) / 4 + ageAdj),
    ageAdj,
  };
}

function bmi(weight, heightCm) {
  const h = heightCm / 100;
  return weight / (h * h);
}

function bmiCategory(bmiVal) {
  if (bmiVal < 18.5) return { label: 'Underweight', color: '#4ea8ff' };
  if (bmiVal < 25)   return { label: 'Healthy Weight', color: '#ff2442' };
  if (bmiVal < 30)   return { label: 'Overweight', color: '#ffc107' };
  if (bmiVal < 35)   return { label: 'Obese Class I', color: '#ff6b35' };
  return               { label: 'Obese Class II', color: '#ff4455' };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CALCULATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setSex(s, btn) {
  sex = s;
  document.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
}

function calculate() {
  const age   = parseFloat(document.getElementById('age').value);
  const h     = parseFloat(document.getElementById('height').value);
  const w     = parseFloat(document.getElementById('weight').value);
  const goal  = parseFloat(document.getElementById('goal-weight').value);
  const act   = parseFloat(document.getElementById('activity').value);
  const def   = parseFloat(document.getElementById('deficit').value);

  if (!age || !h || !w || !goal) { shakeEmpty(); return; }

  // Mifflin-St Jeor
  const bmr  = sex === 'male'
    ? 10*w + 6.25*h - 5*age + 5
    : 10*w + 6.25*h - 5*age - 161;
  const tdee = Math.round(bmr * act);
  const defCals = Math.round(tdee - def);

  const bmrGoal = sex === 'male'
    ? 10*goal + 6.25*h - 5*age + 5
    : 10*goal + 6.25*h - 5*age - 161;
  const tdeeGoal = Math.round(bmrGoal * act);
  const prot  = Math.round(goal * 2.0);
  const fat   = Math.round(goal * 0.9);
  const carb  = Math.max(Math.round((tdeeGoal - prot*4 - fat*9) / 4), 50);
  const toLose = Math.max(w - goal, 0);

  calc = { age, height: h, weight: w, goal, sex, tdee, tdeeGoal, def, defCals, prot, fat, carb, toLose };
  localStorage.setItem('fuel_calc_v3', JSON.stringify(calc));

  // UI: macros
  document.getElementById('r-cals').textContent = defCals;
  document.getElementById('r-prot').textContent = prot;
  document.getElementById('r-fat').textContent  = fat;
  document.getElementById('r-carb').textContent = carb;
  document.getElementById('r-info').textContent =
    `Current TDEE: ${tdee} kcal Â· Maintenance for goal weight: ${tdeeGoal} kcal Â· Need to lose: ${toLose} kg Ã— 8,000 kcal/kg = ${Math.round(toLose*8000).toLocaleString()} kcal total`;

  // Show ideal panel + results
  renderIdealPanel(h, w, goal, age, sex);
  updateProgress();

  const rd = document.getElementById('results');
  rd.style.display = 'block';
  const ip = document.getElementById('ideal-panel');
  ip.style.display = 'block';
  requestAnimationFrame(() => {
    ip.classList.add('in');
    rd.querySelectorAll('.reveal').forEach((el, i) => setTimeout(() => el.classList.add('in'), i*80));
  });
  renderTracker(); // refresh badges with new tdee
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   IDEAL PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderIdealPanel(h, w, goal, age, s) {
  const ideal = idealWeights(h, s, age);
  const bmiVal = bmi(w, h);
  const cat = bmiCategory(bmiVal);
  const bmiGoalVal = bmi(goal, h);

  // Badge
  const badge = document.getElementById('bmi-badge');
  badge.textContent = `BMI ${bmiVal.toFixed(1)} Â· ${cat.label}`;
  badge.style.borderColor = cat.color;
  badge.style.color = cat.color;
  badge.style.background = cat.color + '18';

  // Pointer on scale
  // Scale: <18.5=0%, 18.5=18%, 25=58%, 30=76%, 35=91%, 40+=100%
  function bmiToPos(b) {
    if (b <= 18.5) return Math.max(0, (b / 18.5) * 18);
    if (b <= 25)   return 18 + ((b - 18.5) / 6.5) * 40;
    if (b <= 30)   return 58 + ((b - 25) / 5) * 18;
    if (b <= 35)   return 76 + ((b - 30) / 5) * 15;
    return Math.min(100, 91 + ((b - 35) / 5) * 9);
  }
  const pct = bmiToPos(bmiVal);
  const ptr = document.getElementById('bmi-pointer');
  ptr.style.left = pct + '%';
  ptr.textContent = bmiVal.toFixed(1);

  // Ideal boxes â€” click to autofill goal
  const boxes = [
    { label: 'Devine Formula', val: ideal.devine, sub: 'Clinical standard' },
    { label: 'Robinson Formula', val: ideal.robinson, sub: 'Adjusted Devine' },
    { label: 'Miller Formula', val: ideal.miller, sub: 'Conservative' },
    { label: 'BMI Midpoint', val: Math.round((ideal.bmiRange[0] + ideal.bmiRange[1]) / 2), sub: `Range ${ideal.bmiRange[0]}â€“${ideal.bmiRange[1]} kg` },
  ];

  const grid = document.getElementById('ideal-grid');
  grid.innerHTML = boxes.map(b => {
    const isRec = Math.abs(b.val - ideal.recommended) <= 2;
    return `<div class="ideal-box ${isRec ? 'recommended' : ''}" onclick="applyIdeal(${b.val})" title="Click to set as goal">
      <div class="ideal-box-val">${b.val} kg</div>
      <div class="ideal-box-label">${b.label}</div>
      <div class="ideal-box-sub">${b.sub}</div>
    </div>`;
  }).join('');

  // Recommendation text
  const diff      = +(w - ideal.recommended).toFixed(1);
  const bmiGoalCat = bmiCategory(bmiGoalVal);
  const rec = document.getElementById('rec-box');

  let recTitle, recText;
  if (Math.abs(diff) < 1) {
    recTitle = 'ğŸ¯ YOU\'RE ALREADY AT YOUR IDEAL WEIGHT';
    recText  = `Your current weight of ${w} kg is right on target for your height. Focus on body composition â€” lean mass and fat percentage matter more than the scale at this point.`;
  } else if (diff > 0) {
    const kcalNeeded = Math.round(diff * 8000);
    const daysAt500  = Math.ceil(kcalNeeded / 500);
    recTitle = `ğŸ“‰ RECOMMENDATION: LOSE ${diff} kg`;
    recText  = `Based on your height (${h} cm) and age (${age}), your <strong>recommended ideal weight is ${ideal.recommended} kg</strong> (avg of 4 clinical formulas${ideal.ageAdj > 0 ? `, +${ideal.ageAdj} kg age adjustment` : ''}). That's ${diff} kg to lose â€” requiring ~${kcalNeeded.toLocaleString()} kcal total deficit (~${Math.round(daysAt500/7)} weeks at âˆ’500 kcal/day). Your goal weight of ${goal} kg puts you in the <strong>${bmiGoalCat.label}</strong> category (BMI ${bmiGoalVal.toFixed(1)}).`;
  } else {
    recTitle = `ğŸ“ˆ BELOW IDEAL WEIGHT`;
    recText  = `Your recommended weight for ${h} cm and age ${age} is ${ideal.recommended} kg. You're currently ${Math.abs(diff)} kg below this. Make sure your goal weight of ${goal} kg is healthy â€” BMI ${bmiGoalVal.toFixed(1)} puts you in <strong>${bmiGoalCat.label}</strong>.`;
  }

  rec.innerHTML = `<div class="rec-title">${recTitle}</div><div class="rec-text">${recText}</div>`;
}

function applyIdeal(kg) {
  document.getElementById('goal-weight').value = kg;
  document.getElementById('goal-weight').style.borderColor = 'var(--accent)';
  setTimeout(() => { document.getElementById('goal-weight').style.borderColor = ''; }, 800);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROGRESS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateProgress() {
  if (!calc.def) return;
  const { toLose = 0, def, tdee = 0, weight = 0, goal = 0 } = calc;

  let totalDef = 0, daysLogged = 0;
  Object.values(days).forEach(d => {
    if (!d || d.status === 'miss') return;
    if (d.eaten != null && tdee) {
      totalDef += tdee - d.eaten;
      daysLogged++;
    } else if (d.status === 'done') {
      totalDef += def;
      daysLogged++;
    }
  });

  const kgLost   = Math.max(totalDef / 8000, 0);
  const kgRemain = Math.max(toLose - kgLost, 0);
  const pct      = toLose > 0 ? Math.min(Math.round(kgLost / toLose * 100), 100) : (kgLost > 0 ? 100 : 0);
  const avgDef   = daysLogged > 0 ? totalDef / daysLogged : def;
  const daysLeft = kgRemain > 0 && avgDef > 0 ? Math.ceil(kgRemain * 8000 / avgDef) : 0;

  document.getElementById('prog-pct').textContent   = pct + '%';
  document.getElementById('bar-start').textContent  = weight + ' kg';
  document.getElementById('bar-goal').textContent   = goal + ' kg';
  document.getElementById('bar-mid').textContent    = kgLost > 0.001 ? `âˆ’${kgLost.toFixed(2)} kg` : '';
  setTimeout(() => { document.getElementById('bar-fill').style.width = pct + '%'; }, 100);

  document.getElementById('rp-lost').textContent      = kgLost.toFixed(3);
  document.getElementById('rp-total-def').textContent = totalDef > 0 ? Math.round(totalDef).toLocaleString() : '0';
  document.getElementById('rp-remain').textContent    = kgRemain.toFixed(2);

  // Ring
  const C = 2 * Math.PI * 35;
  const rPct = toLose > 0 ? Math.min(kgLost / toLose, 1) : (kgLost > 0 ? 1 : 0);
  const ring = document.getElementById('ring-fg');
  ring.setAttribute('stroke-dasharray', C);
  ring.style.strokeDashoffset = C * (1 - rPct);

  document.getElementById('cd-days').textContent = daysLeft > 0 ? daysLeft : (kgLost >= toLose && toLose > 0 ? 'ğŸ¯' : 'â€”');
  document.getElementById('cd-title').textContent = daysLeft > 0 ? 'DAYS TO GOAL' : (kgLost >= toLose && toLose > 0 ? 'GOAL REACHED!' : 'DAYS TO GOAL');

  if (daysLeft > 0 && avgDef > 0) {
    const finish = new Date();
    finish.setDate(finish.getDate() + daysLeft);
    document.getElementById('cd-desc').textContent =
      `Avg real deficit: ${Math.round(avgDef)} kcal/day Â· Estimated finish: ${finish.toLocaleDateString('en-GB', {day:'numeric',month:'long',year:'numeric'})}`;
  } else if (toLose === 0) {
    document.getElementById('cd-desc').textContent = 'Maintenance mode â€” no weight loss goal set.';
  } else {
    const estDays = toLose > 0 ? Math.ceil(toLose * 8000 / def) : 0;
    const estDate = new Date();
    estDate.setDate(estDate.getDate() + estDays);
    document.getElementById('cd-desc').textContent =
      `Theory at ${def} kcal/day deficit: ~${estDays} days (${estDate.toLocaleDateString('en-GB', {day:'numeric',month:'long',year:'numeric'})}). Log daily entries for a real prediction.`;
  }

  updateStats();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TRACKER RENDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderTracker() {
  const today = new Date();
  const todayStr = ds(today);

  document.getElementById('cal-header').innerHTML =
    DAYS_S.map(d => `<div class="cal-hcell">${d}</div>`).join('');

  const first = new Date(curYear, curMonth, 1);
  let dow = first.getDay();
  dow = dow === 0 ? 6 : dow - 1;
  const dim = new Date(curYear, curMonth + 1, 0).getDate();
  const grid = document.getElementById('cal-grid');
  grid.innerHTML = '';

  for (let i = 0; i < dow; i++) grid.innerHTML += `<div class="cal-day empty"></div>`;

  for (let d = 1; d <= dim; d++) {
    const date    = new Date(curYear, curMonth, d);
    const key     = ds(date);
    const isToday = key === todayStr;
    const isFut   = date > today && !isToday;
    const entry   = days[key];

    let cls = 'cal-day';
    if (isFut)                    cls += ' future';
    else if (entry?.status === 'done')    cls += ' done';
    else if (entry?.status === 'partial') cls += ' partial';
    else if (entry?.status === 'miss')    cls += ' miss';
    if (isToday) cls += ' today';

    let badge = '';
    if (!isFut && entry) {
      if (entry.eaten != null && calc.tdee) {
        const def = calc.tdee - entry.eaten;
        badge = `<span class="day-def">${def >= 0 ? '+' : ''}${Math.round(def/10)*10}</span>`;
      } else if (entry.status === 'done')    badge = `<span class="day-def">âœ“</span>`;
      else if (entry.status === 'partial')   badge = `<span class="day-def">~</span>`;
      else if (entry.status === 'miss')      badge = `<span class="day-def" style="color:#ff4455">âœ•</span>`;
    }

    const click = isFut ? '' : `onclick="openModal('${key}')"`;
    grid.innerHTML += `<div class="${cls}" ${click}><span class="day-n">${d}</span>${badge}</div>`;
  }

  document.getElementById('month-label').textContent = `${MONTHS[curMonth]} ${curYear}`;
  updateStats();
}

function chMonth(dir) {
  curMonth += dir;
  if (curMonth > 11) { curMonth = 0; curYear++; }
  if (curMonth < 0)  { curMonth = 11; curYear--; }
  renderTracker();
}

function ds(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateStats() {
  const today = new Date();
  // Streak
  let streak = 0, chk = new Date(today);
  while (true) {
    const s = days[ds(chk)]?.status;
    if (s === 'done' || s === 'partial') { streak++; chk.setDate(chk.getDate()-1); }
    else break;
  }
  // Total
  const total = Object.values(days).filter(d => d?.status === 'done' || d?.status === 'partial').length;
  // Avg
  let sumD = 0, cnt = 0;
  Object.values(days).forEach(d => {
    if (d?.eaten != null && calc.tdee) { sumD += calc.tdee - d.eaten; cnt++; }
  });
  const avg = cnt > 0 ? Math.round(sumD / cnt) : 0;
  // Month rate
  const mKey = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
  const done = Object.keys(days).filter(k => k.startsWith(mKey) && (days[k]?.status === 'done' || days[k]?.status === 'partial')).length;
  const rate = Math.round(done / today.getDate() * 100);

  document.getElementById('streak-num').textContent = streak;
  document.getElementById('ts-streak').textContent  = streak;
  document.getElementById('ts-total').textContent   = total;
  document.getElementById('ts-avg').textContent     = avg !== 0 ? avg : 'â€”';
  document.getElementById('ts-rate').textContent    = rate + '%';

  const tips = [
    'Tap any past day to log your real calories. Progress recalculates instantly!',
    `ğŸ”¥ ${streak}-day streak! Keep going â€” don't break the chain!`,
    'ğŸ“Š The more data you log, the more accurate your finish date gets.',
    'âš¡ Every 8,000 kcal of deficit = exactly 1 kg of fat gone. Math works.',
    'ğŸ’ª Consistency beats intensity. Log every day, even the bad ones.',
  ];
  const ti = streak >= 7 ? 1 : streak >= 3 ? 2 : Math.floor(Math.random() * tips.length);
  document.getElementById('tip-text').textContent = tips[Math.min(ti, tips.length-1)];
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openModal(key) {
  mDate   = key;
  const e = days[key] || {};
  mStatus = e.status || null;

  const [y, m, d] = key.split('-').map(Number);
  const date = new Date(y, m-1, d);
  const dow  = date.getDay();
  const di   = dow === 0 ? 6 : dow - 1;
  document.getElementById('m-date').textContent = `${d} ${MONTHS[m-1]} ${y}`;
  document.getElementById('m-dow').textContent  = DAYS_F[di];

  renderStatus(e.status || null);
  document.getElementById('m-eaten').value = e.eaten != null ? e.eaten : '';

  const note = document.getElementById('m-note');
  if (calc.defCals) {
    note.style.display = 'block';
    note.innerHTML = `Your target: <span>${calc.defCals} kcal</span> Â· TDEE: <span>${calc.tdee} kcal</span>`;
  } else { note.style.display = 'none'; }

  recalcM();
  document.getElementById('overlay').classList.add('open');
  setTimeout(() => document.getElementById('m-eaten').focus(), 280);
}

function closeModal() {
  document.getElementById('overlay').classList.remove('open');
  mDate = null;
}
function bgClose(e) { if (e.target === document.getElementById('overlay')) closeModal(); }

function renderStatus(s) {
  ['done','partial','miss'].forEach(id => {
    document.getElementById('sb-' + id).className = 'status-btn' + (s === id ? ` on-${id}` : '');
  });
}

function setStatus(s) {
  mStatus = s;
  renderStatus(s);
}

function recalcM() {
  const eaten = parseFloat(document.getElementById('m-eaten').value);
  const tdee  = calc.tdee;
  if (!isNaN(eaten) && tdee) {
    const def   = tdee - eaten;
    const fatG  = def / 8;
    const fatKg = def / 8000;

    const el = document.getElementById('m-def');
    el.textContent = (def >= 0 ? '+' : '') + Math.round(def);
    el.className   = 'rs-val ' + (def >= 0 ? 'pos' : 'neg');
    document.getElementById('m-fat-g').textContent  = fatG >= 0 ? '+' + fatG.toFixed(1) : fatG.toFixed(1);
    document.getElementById('m-fat-kg').textContent = fatKg >= 0 ? '+' + fatKg.toFixed(4) : fatKg.toFixed(4);

    if (!mStatus) {
      if (def >= (calc.def || 400) * 0.9) setStatus('done');
      else if (def > 0) setStatus('partial');
      else setStatus('miss');
    }
  } else {
    ['m-def','m-fat-g','m-fat-kg'].forEach(id => document.getElementById(id).textContent = 'â€”');
  }
}

function saveDay() {
  if (!mDate) return;
  const eaten = parseFloat(document.getElementById('m-eaten').value);
  days[mDate] = { status: mStatus || 'done', eaten: isNaN(eaten) ? null : eaten };
  localStorage.setItem('fuel_days_v3', JSON.stringify(days));
  closeModal();
  renderTracker();
  updateProgress();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MISC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function confirmReset() {
  if (confirm('Reset all tracker data? This cannot be undone.')) {
    days = {};
    localStorage.removeItem('fuel_days_v3');
    renderTracker();
    updateProgress();
  }
}

function shakeEmpty() {
  ['age','height','weight','goal-weight'].forEach(id => {
    const el = document.getElementById(id);
    if (!el.value) {
      el.style.borderColor = 'var(--red)';
      el.style.animation   = 'shake .35s ease';
      setTimeout(() => { el.style.borderColor = ''; el.style.animation = ''; }, 700);
    }
  });
}

function checkReveal() {
  document.querySelectorAll('.reveal').forEach(el => {
    if (el.getBoundingClientRect().top < window.innerHeight - 30) el.classList.add('in');
  });
}

window.addEventListener('scroll', checkReveal);
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeModal();
  if (e.key === 'Enter' && !document.getElementById('overlay').classList.contains('open')) calculate();
});

/* â”€â”€ RESTORE SAVED STATE â”€â”€ */
if (calc.weight) {
  if (calc.age)    document.getElementById('age').value         = calc.age;
  if (calc.height) document.getElementById('height').value      = calc.height;
  if (calc.weight) document.getElementById('weight').value      = calc.weight;
  if (calc.goal)   document.getElementById('goal-weight').value = calc.goal;
  if (calc.sex === 'female') {
    sex = 'female';
    const btns = document.querySelectorAll('.seg-btn');
    btns[0].classList.remove('on'); btns[1].classList.add('on');
  }
  document.getElementById('r-cals').textContent = calc.defCals || 'â€”';
  document.getElementById('r-prot').textContent = calc.prot    || 'â€”';
  document.getElementById('r-fat').textContent  = calc.fat     || 'â€”';
  document.getElementById('r-carb').textContent = calc.carb    || 'â€”';
  document.getElementById('r-info').textContent =
    `Current TDEE: ${calc.tdee} kcal Â· Maintenance for goal weight: ${calc.tdeeGoal} kcal Â· 1 kg fat = 8,000 kcal`;

  renderIdealPanel(calc.height, calc.weight, calc.goal, calc.age, calc.sex || 'male');
  const ip = document.getElementById('ideal-panel');
  ip.style.display = 'block'; ip.classList.add('in');
  const rd = document.getElementById('results');
  rd.style.display = 'block';
  requestAnimationFrame(() => { rd.querySelectorAll('.reveal').forEach(el => el.classList.add('in')); checkReveal(); });
  updateProgress();
}

renderTracker();
checkReveal();
</script>
</body>
</html>
